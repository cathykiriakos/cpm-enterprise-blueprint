# =============================================================================
# CPM METRICS DEFINITIONS
# Single Source of Truth for All Business Metrics
# =============================================================================
#
# This file defines the canonical definitions for all business metrics.
# Any metric reported by CPM should be defined here.
#
# GOVERNANCE:
# - Changes require approval from Data Governance Committee
# - Version history tracked in git
# - Breaking changes require communication to all stakeholders
#
# VERSION: 1.0.0
# LAST UPDATED: 2025-01-15
# OWNER: Director, Enterprise Systems
# =============================================================================

metadata:
  version: "1.0.0"
  last_updated: "2025-01-15"
  owner: "Director, Enterprise Systems"
  governance_committee:
    - "VP, Membership"
    - "VP, Development"
    - "Director, Marketing"
    - "CFO"

# =============================================================================
# MEMBERSHIP METRICS
# =============================================================================

metrics:
  
  # ---------------------------------------------------------------------------
  # Active Member
  # ---------------------------------------------------------------------------
  active_member:
    display_name: "Active Member"
    category: "membership"
    
    definition: |
      A constituent who has made at least one donation of any amount 
      to WBEZ within the trailing 12 calendar months from the measurement date.
      
      INCLUDES:
      - One-time donations
      - Recurring/sustaining donations
      - Major gifts
      - Event donations (if donation component exists)
      
      EXCLUDES:
      - Event-only ticket purchases (no donation component)
      - Sun-Times subscriptions (tracked separately)
      - Cancelled/refunded donations
    
    business_owner: "VP, Membership"
    data_steward: "Membership Data Analyst"
    
    calculation:
      description: "Count distinct constituents with a donation in trailing 12 months"
      
      # Platform-agnostic SQL template
      sql_template: |
        SELECT COUNT(DISTINCT constituent_id) as active_member_count
        FROM {schema}.constituents c
        WHERE EXISTS (
          SELECT 1 FROM {schema}.donation_facts d
          WHERE d.constituent_id = c.constituent_id
            AND d.donation_date >= {date_subtract}(CURRENT_DATE, 12, 'month')
            AND d.donation_status = 'completed'
        )
      
      # Platform-specific variants
      sql_standard: |
        SELECT COUNT(DISTINCT constituent_id) as active_member_count
        FROM golden.constituents c
        WHERE EXISTS (
          SELECT 1 FROM golden.donation_facts d
          WHERE d.constituent_id = c.constituent_id
            AND d.donation_date >= DATE_ADD(CURRENT_DATE, INTERVAL -12 MONTH)
            AND d.donation_status = 'completed'
        )
      
      sql_snowflake: |
        SELECT COUNT(DISTINCT constituent_id) as active_member_count
        FROM golden.constituents c
        WHERE EXISTS (
          SELECT 1 FROM golden.donation_facts d
          WHERE d.constituent_id = c.constituent_id
            AND d.donation_date >= DATEADD(month, -12, CURRENT_DATE())
            AND d.donation_status = 'completed'
        )
      
      sql_databricks: |
        SELECT COUNT(DISTINCT constituent_id) as active_member_count
        FROM golden.constituents c
        WHERE EXISTS (
          SELECT 1 FROM golden.donation_facts d
          WHERE d.constituent_id = c.constituent_id
            AND d.donation_date >= ADD_MONTHS(CURRENT_DATE(), -12)
            AND d.donation_status = 'completed'
        )
    
    dimensions:
      - name: "by_source"
        description: "WBEZ vs Sun-Times origination"
        sql_fragment: "GROUP BY c.primary_source"
      
      - name: "by_gift_type"
        description: "One-time vs Recurring"
        sql_fragment: "GROUP BY CASE WHEN c.is_sustainer THEN 'Recurring' ELSE 'One-time' END"
      
      - name: "by_acquisition_year"
        description: "Year of first donation"
        sql_fragment: "GROUP BY YEAR(c.first_donation_date)"
    
    refresh_frequency: "daily"
    refresh_time: "06:00 UTC"
    
    data_sources:
      - table: "golden.constituents"
        fields: ["constituent_id"]
      - table: "golden.donation_facts"
        fields: ["constituent_id", "donation_date", "donation_status"]
    
    quality_checks:
      - name: "positive_count"
        rule: "value >= 0"
        severity: "error"
      
      - name: "reasonable_range"
        rule: "value BETWEEN 50000 AND 150000"
        severity: "warning"
        description: "Alert if count is outside expected range"
      
      - name: "day_over_day_change"
        rule: "ABS(value - previous_value) / previous_value < 0.05"
        severity: "warning"
        description: "Alert if >5% change from previous day"
    
    caveats:
      - "Does NOT include 13-month grace period. See 'active_member_with_grace' for that variant."
      - "Event ticket purchases are excluded unless they include a donation component."
      - "Sun-Times subscribers are tracked separately in 'active_subscriber' metric."
    
    related_metrics:
      - "active_member_with_grace"
      - "sustaining_member"
      - "lapsed_member"
    
    history:
      - version: "1.0.0"
        date: "2025-01-15"
        change: "Initial definition"
        author: "C. Kiriakos"

  # ---------------------------------------------------------------------------
  # Active Member with Grace Period
  # ---------------------------------------------------------------------------
  active_member_with_grace:
    display_name: "Active Member (with Grace)"
    category: "membership"
    
    definition: |
      A constituent who has made at least one donation within the trailing 
      13 calendar months. This includes a 1-month grace period beyond the 
      standard 12-month active window.
      
      Used primarily for retention calculations where we want to allow
      donors time to renew before marking them as lapsed.
    
    business_owner: "VP, Membership"
    data_steward: "Membership Data Analyst"
    
    calculation:
      sql_standard: |
        SELECT COUNT(DISTINCT constituent_id) as active_member_grace_count
        FROM golden.constituents c
        WHERE EXISTS (
          SELECT 1 FROM golden.donation_facts d
          WHERE d.constituent_id = c.constituent_id
            AND d.donation_date >= DATE_ADD(CURRENT_DATE, INTERVAL -13 MONTH)
            AND d.donation_status = 'completed'
        )
      
      sql_snowflake: |
        SELECT COUNT(DISTINCT constituent_id) as active_member_grace_count
        FROM golden.constituents c
        WHERE EXISTS (
          SELECT 1 FROM golden.donation_facts d
          WHERE d.constituent_id = c.constituent_id
            AND d.donation_date >= DATEADD(month, -13, CURRENT_DATE())
            AND d.donation_status = 'completed'
        )
      
      sql_databricks: |
        SELECT COUNT(DISTINCT constituent_id) as active_member_grace_count
        FROM golden.constituents c
        WHERE EXISTS (
          SELECT 1 FROM golden.donation_facts d
          WHERE d.constituent_id = c.constituent_id
            AND d.donation_date >= ADD_MONTHS(CURRENT_DATE(), -13)
            AND d.donation_status = 'completed'
        )
    
    refresh_frequency: "daily"
    
    caveats:
      - "Use 'active_member' for external reporting and official counts"
      - "This metric is primarily for internal retention analysis"

  # ---------------------------------------------------------------------------
  # Sustaining Member
  # ---------------------------------------------------------------------------
  sustaining_member:
    display_name: "Sustaining Member"
    category: "membership"
    
    definition: |
      A constituent with an active recurring donation that:
      1. Has not been explicitly cancelled
      2. Has successfully processed at least one payment in the last 90 days
      
      This excludes sustainers with multiple consecutive failed payments,
      even if not formally cancelled.
    
    business_owner: "Director, Membership"
    data_steward: "Membership Data Analyst"
    
    calculation:
      sql_standard: |
        SELECT COUNT(DISTINCT constituent_id) as sustaining_member_count
        FROM golden.constituents c
        WHERE c.is_sustainer = TRUE
          AND c.recurring_status = 'active'
          AND c.last_successful_payment_date >= DATE_ADD(CURRENT_DATE, INTERVAL -90 DAY)
      
      sql_snowflake: |
        SELECT COUNT(DISTINCT constituent_id) as sustaining_member_count
        FROM golden.constituents c
        WHERE c.is_sustainer = TRUE
          AND c.recurring_status = 'active'
          AND c.last_successful_payment_date >= DATEADD(day, -90, CURRENT_DATE())
      
      sql_databricks: |
        SELECT COUNT(DISTINCT constituent_id) as sustaining_member_count
        FROM golden.constituents c
        WHERE c.is_sustainer = TRUE
          AND c.recurring_status = 'active'
          AND c.last_successful_payment_date >= DATE_ADD(CURRENT_DATE(), -90)
    
    dimensions:
      - name: "by_monthly_amount"
        description: "Grouped by monthly giving level"
        sql_fragment: |
          GROUP BY CASE 
            WHEN c.recurring_monthly_amount < 10 THEN 'Under $10'
            WHEN c.recurring_monthly_amount < 25 THEN '$10-24'
            WHEN c.recurring_monthly_amount < 50 THEN '$25-49'
            WHEN c.recurring_monthly_amount < 100 THEN '$50-99'
            ELSE '$100+'
          END
      
      - name: "by_tenure"
        description: "Grouped by sustainer tenure"
        sql_fragment: |
          GROUP BY CASE 
            WHEN DATEDIFF(month, c.sustainer_start_date, CURRENT_DATE) < 6 THEN 'New (0-6 mo)'
            WHEN DATEDIFF(month, c.sustainer_start_date, CURRENT_DATE) < 12 THEN '6-12 mo'
            WHEN DATEDIFF(month, c.sustainer_start_date, CURRENT_DATE) < 24 THEN '1-2 years'
            ELSE '2+ years'
          END
    
    refresh_frequency: "daily"
    
    quality_checks:
      - name: "sustainer_subset_of_active"
        rule: "sustaining_member_count <= active_member_count"
        severity: "error"
        description: "Sustainers should be subset of active members"

  # ---------------------------------------------------------------------------
  # Lapsed Member
  # ---------------------------------------------------------------------------
  lapsed_member:
    display_name: "Lapsed Member"
    category: "membership"
    
    definition: |
      A constituent who:
      1. Made at least one donation in their history (ever was a member)
      2. Has NOT made a donation in the trailing 12 months
      
      These are former donors who have not renewed.
    
    business_owner: "Director, Membership"
    
    calculation:
      sql_standard: |
        SELECT COUNT(DISTINCT constituent_id) as lapsed_member_count
        FROM golden.constituents c
        WHERE c.total_lifetime_giving > 0
          AND c.last_donation_date < DATE_ADD(CURRENT_DATE, INTERVAL -12 MONTH)
      
      sql_snowflake: |
        SELECT COUNT(DISTINCT constituent_id) as lapsed_member_count
        FROM golden.constituents c
        WHERE c.total_lifetime_giving > 0
          AND c.last_donation_date < DATEADD(month, -12, CURRENT_DATE())
      
      sql_databricks: |
        SELECT COUNT(DISTINCT constituent_id) as lapsed_member_count
        FROM golden.constituents c
        WHERE c.total_lifetime_giving > 0
          AND c.last_donation_date < ADD_MONTHS(CURRENT_DATE(), -12)
    
    dimensions:
      - name: "by_lapse_duration"
        description: "How long since last gift"
        sql_fragment: |
          GROUP BY CASE 
            WHEN DATEDIFF(month, c.last_donation_date, CURRENT_DATE) < 18 THEN '12-18 months'
            WHEN DATEDIFF(month, c.last_donation_date, CURRENT_DATE) < 24 THEN '18-24 months'
            WHEN DATEDIFF(month, c.last_donation_date, CURRENT_DATE) < 36 THEN '2-3 years'
            ELSE '3+ years'
          END
    
    refresh_frequency: "daily"

# =============================================================================
# REVENUE METRICS
# =============================================================================

  # ---------------------------------------------------------------------------
  # Total Revenue (Trailing 12 Months)
  # ---------------------------------------------------------------------------
  total_revenue_t12m:
    display_name: "Total Revenue (T12M)"
    category: "revenue"
    
    definition: |
      Total completed donation revenue in the trailing 12 calendar months.
      Includes one-time and recurring gifts. Excludes refunds and chargebacks.
    
    business_owner: "CFO"
    data_steward: "Finance Data Analyst"
    
    calculation:
      sql_standard: |
        SELECT SUM(donation_amount) as total_revenue_t12m
        FROM golden.donation_facts
        WHERE donation_date >= DATE_ADD(CURRENT_DATE, INTERVAL -12 MONTH)
          AND donation_status = 'completed'
      
      sql_snowflake: |
        SELECT SUM(donation_amount) as total_revenue_t12m
        FROM golden.donation_facts
        WHERE donation_date >= DATEADD(month, -12, CURRENT_DATE())
          AND donation_status = 'completed'
      
      sql_databricks: |
        SELECT SUM(donation_amount) as total_revenue_t12m
        FROM golden.donation_facts
        WHERE donation_date >= ADD_MONTHS(CURRENT_DATE(), -12)
          AND donation_status = 'completed'
    
    dimensions:
      - name: "by_gift_type"
        sql_fragment: "GROUP BY donation_type"
      - name: "by_campaign"
        sql_fragment: "GROUP BY campaign_code"
      - name: "by_channel"
        sql_fragment: "GROUP BY acquisition_channel"
    
    refresh_frequency: "daily"
    
    quality_checks:
      - name: "revenue_positive"
        rule: "value >= 0"
        severity: "error"
      - name: "month_over_month_variance"
        rule: "ABS(value - previous_month) / previous_month < 0.20"
        severity: "warning"
        description: "Alert if >20% variance from previous month"

  # ---------------------------------------------------------------------------
  # Average Gift Amount
  # ---------------------------------------------------------------------------
  average_gift_amount:
    display_name: "Average Gift Amount"
    category: "revenue"
    
    definition: |
      Mean donation amount for completed donations in the measurement period.
      Calculated as total revenue divided by total gift count.
    
    business_owner: "VP, Development"
    
    calculation:
      sql_standard: |
        SELECT 
          AVG(donation_amount) as average_gift_amount,
          SUM(donation_amount) as total_revenue,
          COUNT(*) as gift_count
        FROM golden.donation_facts
        WHERE donation_date >= DATE_ADD(CURRENT_DATE, INTERVAL -12 MONTH)
          AND donation_status = 'completed'
      
      sql_snowflake: |
        SELECT 
          AVG(donation_amount) as average_gift_amount,
          SUM(donation_amount) as total_revenue,
          COUNT(*) as gift_count
        FROM golden.donation_facts
        WHERE donation_date >= DATEADD(month, -12, CURRENT_DATE())
          AND donation_status = 'completed'
      
      sql_databricks: |
        SELECT 
          AVG(donation_amount) as average_gift_amount,
          SUM(donation_amount) as total_revenue,
          COUNT(*) as gift_count
        FROM golden.donation_facts
        WHERE donation_date >= ADD_MONTHS(CURRENT_DATE(), -12)
          AND donation_status = 'completed'
    
    refresh_frequency: "daily"

# =============================================================================
# RETENTION METRICS
# =============================================================================

  # ---------------------------------------------------------------------------
  # Donor Retention Rate
  # ---------------------------------------------------------------------------
  donor_retention_rate:
    display_name: "Donor Retention Rate"
    category: "retention"
    
    definition: |
      Percentage of donors from a cohort period who gave again within 
      the following 12 months.
      
      Formula: (Donors who gave in Period 1 AND Period 2) / (Donors in Period 1)
      
      By default, compares the prior year cohort to current year.
    
    business_owner: "VP, Development"
    data_steward: "Development Data Analyst"
    
    calculation:
      sql_standard: |
        WITH prior_year_donors AS (
          SELECT DISTINCT constituent_id
          FROM golden.donation_facts
          WHERE donation_date BETWEEN 
            DATE_ADD(CURRENT_DATE, INTERVAL -24 MONTH) 
            AND DATE_ADD(CURRENT_DATE, INTERVAL -12 MONTH)
          AND donation_status = 'completed'
        ),
        retained_donors AS (
          SELECT DISTINCT d.constituent_id
          FROM golden.donation_facts d
          INNER JOIN prior_year_donors p ON d.constituent_id = p.constituent_id
          WHERE d.donation_date >= DATE_ADD(CURRENT_DATE, INTERVAL -12 MONTH)
          AND d.donation_status = 'completed'
        )
        SELECT 
          (SELECT COUNT(*) FROM retained_donors) * 100.0 / 
          NULLIF((SELECT COUNT(*) FROM prior_year_donors), 0) as retention_rate,
          (SELECT COUNT(*) FROM prior_year_donors) as prior_year_count,
          (SELECT COUNT(*) FROM retained_donors) as retained_count
      
      sql_snowflake: |
        WITH prior_year_donors AS (
          SELECT DISTINCT constituent_id
          FROM golden.donation_facts
          WHERE donation_date BETWEEN 
            DATEADD(month, -24, CURRENT_DATE()) 
            AND DATEADD(month, -12, CURRENT_DATE())
          AND donation_status = 'completed'
        ),
        retained_donors AS (
          SELECT DISTINCT d.constituent_id
          FROM golden.donation_facts d
          INNER JOIN prior_year_donors p ON d.constituent_id = p.constituent_id
          WHERE d.donation_date >= DATEADD(month, -12, CURRENT_DATE())
          AND d.donation_status = 'completed'
        )
        SELECT 
          (SELECT COUNT(*) FROM retained_donors) * 100.0 / 
          NULLIF((SELECT COUNT(*) FROM prior_year_donors), 0) as retention_rate,
          (SELECT COUNT(*) FROM prior_year_donors) as prior_year_count,
          (SELECT COUNT(*) FROM retained_donors) as retained_count
      
      sql_databricks: |
        WITH prior_year_donors AS (
          SELECT DISTINCT constituent_id
          FROM golden.donation_facts
          WHERE donation_date BETWEEN 
            ADD_MONTHS(CURRENT_DATE(), -24) 
            AND ADD_MONTHS(CURRENT_DATE(), -12)
          AND donation_status = 'completed'
        ),
        retained_donors AS (
          SELECT DISTINCT d.constituent_id
          FROM golden.donation_facts d
          INNER JOIN prior_year_donors p ON d.constituent_id = p.constituent_id
          WHERE d.donation_date >= ADD_MONTHS(CURRENT_DATE(), -12)
          AND d.donation_status = 'completed'
        )
        SELECT 
          (SELECT COUNT(*) FROM retained_donors) * 100.0 / 
          NULLIF((SELECT COUNT(*) FROM prior_year_donors), 0) as retention_rate,
          (SELECT COUNT(*) FROM prior_year_donors) as prior_year_count,
          (SELECT COUNT(*) FROM retained_donors) as retained_count
    
    refresh_frequency: "weekly"
    refresh_day: "Monday"
    
    quality_checks:
      - name: "valid_percentage"
        rule: "value BETWEEN 0 AND 100"
        severity: "error"
      - name: "reasonable_retention"
        rule: "value BETWEEN 30 AND 80"
        severity: "warning"
        description: "Alert if retention outside typical range"

  # ---------------------------------------------------------------------------
  # Sustainer Churn Rate
  # ---------------------------------------------------------------------------
  sustainer_churn_rate:
    display_name: "Sustainer Churn Rate"
    category: "retention"
    
    definition: |
      Monthly percentage of sustaining members who cancelled their 
      recurring gift or had 3+ consecutive failed payments.
      
      Formula: (Sustainers who churned in month) / (Active sustainers at start of month)
    
    business_owner: "Director, Membership"
    
    calculation:
      sql_standard: |
        WITH month_start_sustainers AS (
          SELECT COUNT(DISTINCT constituent_id) as start_count
          FROM golden.constituents
          WHERE is_sustainer = TRUE
            AND recurring_status = 'active'
            -- Snapshot from start of month would come from history table
        ),
        churned_sustainers AS (
          SELECT COUNT(DISTINCT constituent_id) as churn_count
          FROM golden.sustainer_status_changes
          WHERE change_type IN ('cancelled', 'payment_failed_final')
            AND change_date >= DATE_TRUNC('month', CURRENT_DATE)
        )
        SELECT 
          c.churn_count * 100.0 / NULLIF(s.start_count, 0) as churn_rate,
          c.churn_count,
          s.start_count
        FROM churned_sustainers c, month_start_sustainers s
    
    refresh_frequency: "monthly"
    refresh_day: "1"  # First of month for prior month

# =============================================================================
# ENGAGEMENT METRICS
# =============================================================================

  # ---------------------------------------------------------------------------
  # Email Open Rate
  # ---------------------------------------------------------------------------
  email_open_rate:
    display_name: "Email Open Rate"
    category: "engagement"
    
    definition: |
      Percentage of delivered emails that were opened at least once.
      Calculated over the trailing 30 days by default.
      
      Note: Open tracking has limitations due to image blocking and 
      privacy features in email clients.
    
    business_owner: "Director, Marketing"
    
    calculation:
      sql_standard: |
        SELECT 
          SUM(CASE WHEN opened = TRUE THEN 1 ELSE 0 END) * 100.0 / 
            NULLIF(COUNT(*), 0) as open_rate,
          COUNT(*) as emails_sent,
          SUM(CASE WHEN opened = TRUE THEN 1 ELSE 0 END) as emails_opened
        FROM golden.email_engagement
        WHERE send_date >= DATE_ADD(CURRENT_DATE, INTERVAL -30 DAY)
          AND delivery_status = 'delivered'
    
    dimensions:
      - name: "by_email_type"
        sql_fragment: "GROUP BY email_type"
      - name: "by_audience_segment"
        sql_fragment: "GROUP BY audience_segment"
    
    refresh_frequency: "daily"

# =============================================================================
# SUBSCRIBER METRICS (Sun-Times specific)
# =============================================================================

  # ---------------------------------------------------------------------------
  # Active Subscriber
  # ---------------------------------------------------------------------------
  active_subscriber:
    display_name: "Active Subscriber"
    category: "subscription"
    
    definition: |
      A constituent with an active Sun-Times subscription (print or digital)
      that has not been cancelled and is in good payment standing.
    
    business_owner: "Director, Circulation"
    
    calculation:
      sql_standard: |
        SELECT COUNT(DISTINCT constituent_id) as active_subscriber_count
        FROM golden.subscription_facts
        WHERE subscription_status = 'active'
          AND (end_date IS NULL OR end_date > CURRENT_DATE)
      
      sql_snowflake: |
        SELECT COUNT(DISTINCT constituent_id) as active_subscriber_count
        FROM golden.subscription_facts
        WHERE subscription_status = 'active'
          AND (end_date IS NULL OR end_date > CURRENT_DATE())
      
      sql_databricks: |
        SELECT COUNT(DISTINCT constituent_id) as active_subscriber_count
        FROM golden.subscription_facts
        WHERE subscription_status = 'active'
          AND (end_date IS NULL OR end_date > CURRENT_DATE())
    
    dimensions:
      - name: "by_subscription_type"
        sql_fragment: "GROUP BY subscription_type"
    
    refresh_frequency: "daily"

# =============================================================================
# LIFETIME VALUE METRICS
# =============================================================================

  # ---------------------------------------------------------------------------
  # Lifetime Value (LTV)
  # ---------------------------------------------------------------------------
  lifetime_value:
    display_name: "Lifetime Value (LTV)"
    category: "value"
    
    definition: |
      Estimated total value a constituent will provide over their 
      relationship with CPM.
      
      Simplified calculation:
      LTV = Average Annual Gift × Average Tenure (years) × Gross Margin
      
      More sophisticated models incorporate:
      - Retention probability by year
      - Upgrade/downgrade patterns
      - Multi-product engagement
    
    business_owner: "VP, Development"
    
    calculation:
      description: |
        This is a derived metric calculated at the constituent level.
        See the ML model documentation for the full LTV model specification.
      
      sql_standard: |
        SELECT 
          constituent_id,
          total_lifetime_giving,
          DATEDIFF(year, first_donation_date, CURRENT_DATE) as tenure_years,
          total_lifetime_giving / NULLIF(DATEDIFF(year, first_donation_date, CURRENT_DATE), 0) as avg_annual_giving,
          estimated_ltv  -- From ML model
        FROM golden.constituents
        WHERE total_lifetime_giving > 0
    
    refresh_frequency: "weekly"